<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title id="page-title">Dhankeshri Play - Bulk Coupons B</title>
    <link rel="stylesheet" href="style.css">
    <script src="config.js"></script>
    <script>
        window.addEventListener('DOMContentLoaded', () => {
            document.title = `${appGlobalConfig.appName} - Bulk Coupons B`;
            const userSpan = document.querySelector('.top-info span:first-child');
            const balanceSpan = document.querySelector('.top-info span:last-child');
            if (userSpan) userSpan.textContent = `Welcome : ${appGlobalConfig.unique_id}`;
            if (balanceSpan) balanceSpan.textContent = `Balance Point : ${appGlobalConfig.balance}`;
        });
    </script>

    <style>
        .input-cell {
            padding: 2px !important;
            font-size: 24px !important;
            font-weight: 600 !important;
        }
    </style>
</head>

<body>
    <div class="top-bar">
        <div class="version-info">0.0.12</div>
        <div class="top-info">
            <span id="welcome-id">Welcome : 2101400016</span>
            <span id="balance-pts">Balance Point : 97885.30</span>
        </div>
        <div class="top-right-info">
            <button class="lobby-btn" onclick="location.href='index.html'">LOBBY [Q]</button>
        </div>
    </div>

    <div class="container fade-in">
        <div class="tabs-row">
            <div class="menu-tabs">
                <button class="tab tab-bulk-a" onclick="location.href='bulk-coupons.html'">Bulk Coupons [ A ]</button>
                <button class="tab tab-bulk-b active" onclick="location.href='bulk-coupons-b.html'">Bulk Coupons [ B
                    ]</button>
                <button class="tab tab-pointwise">Pointwise Coupons</button>
                <button class="tab tab-loose" onclick="location.href='loose-coupons.html'">Loose Coupons</button>
                <button class="tab tab-loose-pointwise">Loose Pointwise Coupons</button>
            </div>
            <div class="tabs-right">
                <span id="current-date">Date : 18:02:2026</span>
                <span id="event-code">Gift Event Code : 11:00</span>
                <span id="countdown-timer">Countdown : 00:04:16</span>
            </div>
        </div>

        <div style="display: none;">
            <input type="hidden" id="pointRate" value="1.10">
        </div>

        <div class="data-table-container">
            <table class="data-table">
                <thead>
                    <tr>
                        <th style="width: 200px;">Product Group</th>
                        <th style="width: 100px;">Gift Coin</th>
                        <th>00-90</th>
                        <th>01-91</th>
                        <th>02-92</th>
                        <th>03-93</th>
                        <th>04-94</th>
                        <th>05-95</th>
                        <th>06-96</th>
                        <th>07-97</th>
                        <th>08-98</th>
                        <th>09-99</th>
                        <th>All</th>
                        <th style="width: 80px;">Qty</th>
                        <th style="width: 80px;">Pts</th>
                        <th id="draw-time-header" style="width: 100px;">--:--</th>
                    </tr>
                </thead>
                <tbody id="couponBody">
                    <!-- Dynamic rows will be here -->
                </tbody>
                <tfoot>
                    <tr style="background-color: var(--header-bg); font-weight: bold;">
                        <td>All</td>
                        <td>-</td>
                        <td><input type="text" class="input-cell global-range-input" data-col="0" inputmode="numeric">
                        </td>
                        <td><input type="text" class="input-cell global-range-input" data-col="1" inputmode="numeric">
                        </td>
                        <td><input type="text" class="input-cell global-range-input" data-col="2" inputmode="numeric">
                        </td>
                        <td><input type="text" class="input-cell global-range-input" data-col="3" inputmode="numeric">
                        </td>
                        <td><input type="text" class="input-cell global-range-input" data-col="4" inputmode="numeric">
                        </td>
                        <td><input type="text" class="input-cell global-range-input" data-col="5" inputmode="numeric">
                        </td>
                        <td><input type="text" class="input-cell global-range-input" data-col="6" inputmode="numeric">
                        </td>
                        <td><input type="text" class="input-cell global-range-input" data-col="7" inputmode="numeric">
                        </td>
                        <td><input type="text" class="input-cell global-range-input" data-col="8" inputmode="numeric">
                        </td>
                        <td><input type="text" class="input-cell global-range-input" data-col="9" inputmode="numeric">
                        </td>
                        <td style="text-align: right;">TOTAL</td>
                        <td id="totalQty">0</td>
                        <td id="totalPts">0.00</td>
                        <td></td>
                    </tr>
                </tfoot>
            </table>
        </div>

        <div class="bottom-actions">
            <button class="action-btn btn-green">UPCOMMING [F1]</button>
            <button class="action-btn btn-green" id="buyBtn">SUBMIT [F2]</button>
            <button class="action-btn btn-red" onclick="clearAll()">CLEAR [F3]</button>
            <button class="action-btn btn-red" id="cancelBtn">CANCEL [F4]</button>
            <button class="action-btn btn-red" onclick="location.href='result.html'">MOHINI [F5]</button>
            <button class="action-btn btn-red" onclick="location.href='report.html'">C. DETAILS [F6]</button>
            <button class="action-btn btn-red" onclick="location.href='summary.html'">P. SUM [F7]</button>
        </div>
    </div>

    <script>
        const appConfig = {
            drawTime: '09:15',
            groups: SHARED_GROUPS
        };

        const couponBody = document.getElementById('couponBody');
        const drawTimeHeader = document.getElementById('draw-time-header');

        function initUI() {
            drawTimeHeader.textContent = appConfig.drawTime;
            couponBody.innerHTML = '';

            appConfig.groups.forEach(group => {
                const tr = document.createElement('tr');
                tr.className = 'coupon-row';
                tr.setAttribute('data-game-code', group.code);

                let html = `<td>${group.name} ${group.code}</td><td>-</td>`;
                for (let i = 0; i < 10; i++) {
                    html += `<td><input type="text" class="input-cell range-input" inputmode="numeric" data-num="${i}"></td>`;
                }
                html += `
                    <td><input type="text" class="input-cell all-input" style="width: 50px;" inputmode="numeric"></td>
                    <td class="qty-cell">0</td>
                    <td class="pts-cell">0.00</td>
                    <td class="result-cell" style="font-weight: bold; font-size: 14px;">-</td>
                `;
                tr.innerHTML = html;
                couponBody.appendChild(tr);
            });

            if (typeof updateDynamicUI === 'function') updateDynamicUI();
        }

        // Real-time UI Updates
        window.updateDynamicUI = function () {
            if (!window.appGameDetails) return;
            const results = window.appGameDetails.prev_game_results || [];
            if (results.length > 0 && results[0].time) {
                drawTimeHeader.textContent = results[0].time;
            }
            const resultCells = document.querySelectorAll('.result-cell');
            resultCells.forEach((cell, index) => {
                if (results[index] && results[index].win_code) {
                    cell.textContent = results[index].win_code;
                } else {
                    cell.textContent = '-';
                }
            });
        }

        initUI();

        // Custom Cursor Implementation
        let customCursor = null;
        function createCustomCursor() {
            if (!customCursor) {
                customCursor = document.createElement('div');
                customCursor.className = 'custom-cursor';
                customCursor.style.zIndex = '1000';
                document.body.appendChild(customCursor);
            }
        }

        function updateCursorPosition(input) {
            if (!customCursor) createCustomCursor();
            const rect = input.getBoundingClientRect();
            const inputStyle = window.getComputedStyle(input);
            const span = document.createElement('span');
            span.style.font = inputStyle.font;
            span.style.visibility = 'hidden';
            span.style.position = 'absolute';
            span.style.whiteSpace = 'pre';
            document.body.appendChild(span);
            span.textContent = input.value || '';
            const fullTextWidth = span.offsetWidth;
            const valueUpToCursor = input.value.substring(0, input.selectionStart);
            span.textContent = valueUpToCursor || '0';
            const cursorTextWidth = input.value ? (span.textContent === valueUpToCursor ? span.offsetWidth : 0) : 0;
            const spanHeight = Math.max(span.offsetHeight, 16);
            document.body.removeChild(span);
            customCursor.style.height = spanHeight + 'px';
            const verticalCenter = rect.top + window.scrollY + (rect.height - spanHeight) / 2;
            customCursor.style.top = verticalCenter + 'px';
            const inputCenterX = rect.left + window.scrollX + (rect.width / 2);
            let cursorLeft = inputCenterX - (fullTextWidth / 2) + cursorTextWidth - 2;
            customCursor.style.left = cursorLeft + 'px';
            customCursor.style.display = 'block';
        }

        let activeInput = null;
        document.addEventListener('focus', (e) => {
            if (e.target && e.target.classList && e.target.classList.contains('input-cell')) {
                activeInput = e.target;
                createCustomCursor();
                updateCursorPosition(e.target);
            }
        }, true);
        document.addEventListener('blur', (e) => {
            if (e.target && e.target.classList && e.target.classList.contains('input-cell') && customCursor) {
                activeInput = null;
                customCursor.style.display = 'none';
            }
        }, true);
        ['input', 'click', 'keydown', 'keyup'].forEach(ev => {
            document.addEventListener(ev, (e) => {
                if (e.target && e.target.classList && e.target.classList.contains('input-cell') && customCursor) {
                    requestAnimationFrame(() => updateCursorPosition(e.target));
                }
            }, true);
        });
        document.addEventListener('selectionchange', () => {
            if (activeInput && customCursor) requestAnimationFrame(() => updateCursorPosition(activeInput));
        });
        window.addEventListener('scroll', () => {
            if (activeInput && customCursor) requestAnimationFrame(() => updateCursorPosition(activeInput));
        }, true);

        const pointRateInput = document.getElementById('pointRate');
        const totalQtyEl = document.getElementById('totalQty');
        const totalPtsEl = document.getElementById('totalPts');

        async function handleBuy() {
            if (!window.appGameDetails || !window.appGameDetails.timeSlotId) {
                showPopup("Game details not loaded yet.", "Error");
                await updateLiveHeader();
                if (!window.appGameDetails.timeSlotId) return;
            }
            const tickets = [];
            document.querySelectorAll('.coupon-row').forEach(row => {
                const code = row.getAttribute('data-game-code');
                const gameTypeId = code.includes('RM') ? 1 : code.includes('RG') ? 2 : code.includes('RY') ? 3 : 4;
                row.querySelectorAll('.range-input').forEach(input => {
                    const qty = parseInt(input.value) || 0;
                    if (qty > 0) {
                        tickets.push({
                            game_id: 2, // Bulk B
                            game_type_id: gameTypeId,
                            number: input.getAttribute('data-num'),
                            time_slot_id: [window.appGameDetails.timeSlotId],
                            ticket_date: window.appGameDetails.date,
                            qty: qty.toString()
                        });
                    }
                });
            });
            if (tickets.length === 0) { showPopup("Please enter the Bet", "Warning"); return; }
            const result = await postData(CONFIG.TICKET_PURCHASE_URL, { userId: appGlobalConfig.userId, tickets }, "Ticket Purchased Successfully");
            if (result) { clearAll(); if (typeof updateLiveBalance === 'function') updateLiveBalance(); }
        }

        async function handleCancel() {
            const result = await postData(CONFIG.CANCEL_TICKETS_URL, { userId: appGlobalConfig.userId }, "Ticket Cancelled Successfully");
            if (result && typeof updateLiveBalance === 'function') updateLiveBalance();
        }

        document.getElementById('buyBtn').addEventListener('click', handleBuy);
        document.getElementById('cancelBtn').addEventListener('click', handleCancel);

        function calculate() {
            let gQty = 0, gPts = 0;
            const rate = parseFloat(pointRateInput ? pointRateInput.value : 1.0) || 1.0;
            document.querySelectorAll('.coupon-row').forEach(row => {
                let rQty = 0;
                row.querySelectorAll('.range-input').forEach(i => rQty += parseInt(i.value) || 0);
                const rPts = rQty * rate * 10;
                row.querySelector('.qty-cell').textContent = rQty;
                row.querySelector('.pts-cell').textContent = rPts.toFixed(2);
                gQty += rQty; gPts += rPts;
            });
            totalQtyEl.textContent = gQty;
            totalPtsEl.textContent = gPts.toFixed(2);
        }

        document.addEventListener('input', (e) => {
            if (e.target && e.target.classList && (e.target.classList.contains('input-cell') || e.target.id === 'pointRate')) {
                if (e.target.classList.contains('input-cell')) e.target.value = e.target.value.replace(/[^0-9]/g, '');
                if (e.target.classList.contains('global-range-input') || e.target.classList.contains('all-input')) {
                    const cur = parseInt(e.target.value) || 0;
                    const prev = parseInt(e.target.getAttribute('data-prev-val')) || 0;
                    const delta = cur - prev;
                    if (e.target.classList.contains('global-range-input')) {
                        const col = e.target.dataset.col;
                        document.querySelectorAll('.coupon-row').forEach(row => {
                            const inp = row.querySelectorAll('.range-input')[col];
                            const nv = (parseInt(inp.value) || 0) + delta; inp.value = nv > 0 ? nv : '';
                        });
                    } else {
                        e.target.closest('tr').querySelectorAll('.range-input').forEach(inp => {
                            const nv = (parseInt(inp.value) || 0) + delta; inp.value = nv > 0 ? nv : '';
                        });
                    }
                    e.target.setAttribute('data-prev-val', cur);
                }
                calculate();
            }
        });

        document.addEventListener('focus', (e) => {
            if (e.target && e.target.classList && (e.target.classList.contains('global-range-input') || e.target.classList.contains('all-input'))) {
                e.target.setAttribute('data-prev-val', e.target.value || '0');
            }
        }, true);

        document.addEventListener('blur', (e) => {
            // No longer clearing value on blur to allow persistence
        }, true);

        function clearAll() { document.querySelectorAll('.input-cell').forEach(i => i.value = ''); calculate(); }

        document.addEventListener('keydown', (e) => {
            const inputs = Array.from(document.querySelectorAll('.input-cell'));
            const idx = inputs.indexOf(e.target);
            if (idx !== -1) {
                if (['ArrowUp', 'ArrowDown', 'ArrowLeft', 'ArrowRight'].includes(e.key)) {
                    e.preventDefault();
                    let target = null;
                    if (e.key === 'ArrowLeft') target = inputs[idx - 1];
                    else if (e.key === 'ArrowRight') target = inputs[idx + 1];
                    else {
                        const rect = e.target.getBoundingClientRect();
                        const cx = rect.left + rect.width / 2;
                        let minD = Infinity;
                        inputs.forEach(inp => {
                            if (inp === e.target) return;
                            const r = inp.getBoundingClientRect();
                            const icx = r.left + r.width / 2, icy = r.top + r.height / 2;
                            if (e.key === 'ArrowUp' && icy < rect.top) {
                                const d = rect.top - icy;
                                if (Math.abs(icx - cx) < rect.width / 2 && d < minD) { minD = d; target = inp; }
                            } else if (e.key === 'ArrowDown' && icy > rect.bottom) {
                                const d = icy - rect.bottom;
                                if (Math.abs(icx - cx) < rect.width / 2 && d < minD) { minD = d; target = inp; }
                            }
                        });
                    }
                    if (target) target.focus();
                }
            }
            if (e.key === 'F3') { e.preventDefault(); clearAll(); }
            else if (e.key === 'F2') { e.preventDefault(); handleBuy(); }
            else if (e.key === 'F4') { e.preventDefault(); handleCancel(); }
            else if (e.key === 'F5') { e.preventDefault(); location.href = 'result.html'; }
            else if (e.key === 'F7') { e.preventDefault(); location.href = 'summary.html'; }
            else if (e.key.toLowerCase() === 'q' && e.target.tagName !== 'INPUT') location.href = 'index.html';
        });
        calculate();
    </script>
</body>

</html>