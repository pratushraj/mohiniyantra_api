<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title id="page-title">Dhankeshri Play - Loose Coupons</title>
    <link rel="stylesheet" href="style.css">
    <script src="config.js"></script>
    <script>
        window.addEventListener('DOMContentLoaded', () => {
            document.title = `${appGlobalConfig.appName} - Loose Coupons`;
            const userSpan = document.querySelector('#welcome-id');
            const balanceSpan = document.querySelector('#balance-pts');
            if (userSpan) userSpan.textContent = `Welcome : ${appGlobalConfig.unique_id}`;
            if (balanceSpan) balanceSpan.textContent = `Balance Point : ${appGlobalConfig.balance}`;
        });
    </script>
    <style>
        .input-cell {
            padding: 2px !important;
            font-size: 24px !important;
            font-weight: 600 !important;
        }
    </style>
</head>

<body>
    <div class="top-bar">
        <div class="version-info">0.0.12</div>
        <div class="top-info">
            <span id="welcome-id">Welcome : 2101400016</span>
            <span id="balance-pts">Balance Point : 97885.30</span>
        </div>
        <div class="top-right-info">
            <button class="lobby-btn" onclick="location.href='index.html'">LOBBY [Q]</button>
        </div>
    </div>

    <div class="container fade-in">
        <div class="tabs-row">
            <div class="menu-tabs">
                <button class="tab tab-bulk-a" onclick="location.href='bulk-coupons.html'">Bulk Coupons [ A ]</button>
                <button class="tab tab-bulk-b" onclick="location.href='bulk-coupons-b.html'">Bulk Coupons [ B ]</button>
                <button class="tab tab-pointwise">Pointwise Coupons</button>
                <button class="tab tab-loose active" onclick="location.href='loose-coupons.html'">Loose Coupons</button>
                <button class="tab tab-loose-pointwise">Loose Pointwise Coupons</button>
            </div>
            <div class="tabs-right">
                <span id="current-date">Date : 18:02:2026</span>
                <span id="event-code">Gift Event Code : 11:00</span>
                <span id="countdown-timer">Countdown : 00:04:16</span>
            </div>
        </div>

        <!-- Header for Loose Coupons -->
        <div id="draw-header" style="display: flex; background: #eee8aa; border: 1px solid #999; margin-top: 0;">
            <div class="header-draw-info" id="head-NV"
                style="flex: 1; border-right: 1px solid #999; text-align: center; padding: 5px; font-weight: bold;">NV78
                | 09:30</div>
            <div class="header-draw-info" id="head-RR"
                style="flex: 1; border-right: 1px solid #999; text-align: center; padding: 5px; font-weight: bold;">RR48
                | 09:30</div>
            <div class="header-draw-info" id="head-RY"
                style="flex: 1; border-right: 1px solid #999; text-align: center; padding: 5px; font-weight: bold;">RY38
                | 09:30</div>
            <div class="header-draw-info" id="head-CH"
                style="flex: 1; text-align: center; padding: 5px; font-weight: bold;">CH93 | 09:30</div>
        </div>
        <div id="sub-tabs-container" style="display: flex; background: #fff; border: 1px solid #999; border-top: none;">
            <div class="sub-tab active" data-id="NV" onclick="switchSubTab(this)">NV</div>
            <div class="sub-tab" data-id="RR" onclick="switchSubTab(this)">RR</div>
            <div class="sub-tab" data-id="RY" onclick="switchSubTab(this)">RY</div>
            <div class="sub-tab" data-id="CH" onclick="switchSubTab(this)">CH</div>
        </div>

        <div class="loose-grid-container" style="margin-top: 5px;">
            <div class="loose-grid" id="numberGrid">
                <!-- Grid will be populated by logic -->
            </div>
        </div>

        <div class="bottom-actions" style="margin-top: 10px;">
            <button class="action-btn btn-green">UPCOMMING [F1]</button>
            <button class="action-btn btn-green" onclick="handleBuy()">SUBMIT [F2]</button>
            <button class="action-btn btn-red" onclick="clearAll(); for(let key in tabState) tabState[key]={};">CLEAR
                [F3]</button>
            <button class="action-btn btn-red" id="cancelBtn">CANCEL [F4]</button>
            <button class="action-btn btn-red" onclick="location.href='result.html'">MOHINI [F5]</button>
            <button class="action-btn btn-red" onclick="location.href='report.html'">C. DETAILS [F6]</button>
            <button class="action-btn btn-red" onclick="location.href='summary.html'">P. SUM [F7]</button>
        </div>
    </div>

    <script>
        // Dynamic Configuration for Group Names and Details
        const appConfig = {
            balance: appGlobalConfig.balance,
            groups: SHARED_GROUPS
        };

        function updateDynamicUI() {
            const results = window.appGameDetails ? (window.appGameDetails.prev_game_results || []) : [];
            const headerEls = document.querySelectorAll('.header-draw-info');
            const tabEls = document.querySelectorAll('.sub-tab');

            appConfig.groups.forEach((group, index) => {
                const headEl = headerEls[index];
                if (headEl) {
                    const resObj = results[index] || {};
                    const prevTime = resObj.time || '--:--';
                    const winCode = resObj.win_code || '-';
                    headEl.textContent = `${prevTime} | ${winCode}`;
                }
                if (tabEls[index]) {
                    tabEls[index].textContent = group.code;
                    tabEls[index].setAttribute('data-id', group.id);
                }
            });
        }

        let currentTab = null;
        const tabState = {};

        function initTabSystem() {
            if (appConfig.groups.length > 0) {
                if (!currentTab) currentTab = appConfig.groups[0].id;
                appConfig.groups.forEach(g => {
                    if (!tabState[g.id]) tabState[g.id] = {};
                });
            }
        }

        function saveTabState() {
            if (!currentTab) {
                if (appConfig.groups.length > 0) currentTab = appConfig.groups[0].id;
                else return;
            }
            const data = {};
            document.querySelectorAll('.number-input').forEach(input => {
                if (input.value) {
                    const num = input.getAttribute('data-row') + input.getAttribute('data-col');
                    data[num] = input.value;
                }
            });
            tabState[currentTab] = data;
        }

        // Add to updateDynamicUI or a separate sync handler
        const originalUpdateDynamicUI = (typeof updateDynamicUI === 'function') ? updateDynamicUI : null;
        updateDynamicUI = function () {
            if (originalUpdateDynamicUI) originalUpdateDynamicUI();
            initTabSystem();
        }
        initTabSystem();

        function switchSubTab(element) {
            saveTabState();
            document.querySelectorAll('.sub-tab').forEach(tab => tab.classList.remove('active'));
            element.classList.add('active');
            currentTab = element.getAttribute('data-id');
            const newData = tabState[currentTab] || {};
            document.querySelectorAll('.number-input').forEach(input => {
                const num = input.getAttribute('data-row') + input.getAttribute('data-col');
                input.value = newData[num] || '';
            });
            document.querySelectorAll('.grid-input:not(.number-input)').forEach(i => i.value = '');
            updateTotals();
        }

        async function handleBuy() {
            saveTabState();
            if (!window.appGameDetails || !window.appGameDetails.timeSlotId) {
                showPopup("Game details not loaded yet.", "Error");
                await updateLiveHeader();
                if (!window.appGameDetails.timeSlotId) return;
            }
            const tickets = [];
            SHARED_GROUPS.forEach(group => {
                const data = tabState[group.id] || {};
                const gameTypeId = group.id;
                for (let num in data) {
                    tickets.push({
                        game_id: 3,
                        game_type_id: gameTypeId,
                        number: num,
                        time_slot_id: [window.appGameDetails.timeSlotId],
                        ticket_date: window.appGameDetails.date,
                        qty: data[num].toString()
                    });
                }
            });
            if (tickets.length === 0) { showPopup("Please enter the Bet", "Warning"); return; }
            const result = await postData(CONFIG.TICKET_PURCHASE_URL, { userId: appGlobalConfig.userId, tickets }, "Ticket Purchased Successfully");
            if (result) {
                for (let key in tabState) tabState[key] = {};
                clearAll();
                if (typeof updateLiveBalance === 'function') updateLiveBalance();
            }
        }

        const grid = document.getElementById('numberGrid');
        const POINT_RATE = 1.10;

        async function handleCancel() {
            const request = {
                userId: appGlobalConfig.userId,
                gameId: 3 // Double Game
            };
            const result = await postData(CONFIG.CANCEL_TICKETS_URL, request, "Ticket Cancelled Successfully");
            if (result && typeof updateLiveBalance === 'function') updateLiveBalance();
        }

        const rowsData = [
            ['00', '01', '02', '03', '04', '05', '06', '07', '08', '09', 'A0'],
            ['10', '11', '12', '13', '14', '15', '16', '17', '18', '19', 'A1'],
            ['20', '21', '22', '23', '24', '25', '26', '27', '28', '29', 'A2'],
            ['30', '31', '32', '33', '34', '35', '36', '37', '38', '39', 'A3'],
            ['40', '41', '42', '43', '44', '45', '46', '47', '48', '49', 'A4'],
            ['50', '51', '52', '53', '54', '55', '56', '57', '58', '59', 'A5'],
            ['60', '61', '62', '63', '64', '65', '66', '67', '68', '69', 'A6'],
            ['70', '71', '72', '73', '74', '75', '76', '77', '78', '79', 'A7'],
            ['80', '81', '82', '83', '84', '85', '86', '87', '88', '89', 'A8'],
            ['90', '91', '92', '93', '94', '95', '96', '97', '98', '99', 'A9'],
            ['B0', 'B1', 'B2', 'B3', 'B4', 'B5', 'B6', 'B7', 'B8', 'B9', 'Qty. 0'],
            ['C0', 'C1', 'C2', 'C3', 'C4', 'C5', 'C6', 'C7', 'C8', 'C9', 'Pts 0.00']
        ];

        grid.innerHTML = '';
        grid.style.gridTemplateColumns = 'repeat(11, 1fr)';

        rowsData.forEach((row, rowIndex) => {
            row.forEach((val, colIndex) => {
                if (val.startsWith('Qty.') || val.startsWith('Pts')) {
                    const textDiv = document.createElement('div');
                    textDiv.id = val.startsWith('Qty') ? 'qtyDisplay' : 'ptsDisplay';
                    textDiv.textContent = val;
                    textDiv.style.display = 'flex';
                    textDiv.style.alignItems = 'center';
                    textDiv.style.justifyContent = 'center';
                    textDiv.style.fontWeight = 'bold';
                    textDiv.style.fontSize = '18px';
                    grid.appendChild(textDiv);
                    return;
                }
                const input = document.createElement('input');
                input.className = 'grid-input';
                input.style.border = '1px solid #ccc';
                input.style.height = '34px';
                input.style.width = '55%';
                input.style.margin = '0px auto';
                input.type = 'text';
                input.placeholder = val;

                if (rowIndex < 10 && colIndex < 10) {
                    input.classList.add('number-input');
                    input.setAttribute('data-row', rowIndex);
                    input.setAttribute('data-col', colIndex);
                } else if (rowIndex < 10 && colIndex === 10) {
                    input.classList.add('fill-column');
                    input.setAttribute('data-target-index', rowIndex);
                } else if (rowIndex === 10 && colIndex < 10) {
                    input.classList.add('fill-row');
                    input.setAttribute('data-target-index', colIndex);
                } else if (rowIndex === 11 && colIndex < 10) {
                    input.classList.add('fill-digit-sum');
                    input.setAttribute('data-target-index', colIndex);
                }
                grid.appendChild(input);
            });
        });

        // Custom Cursor Implementation
        let customCursor = null;
        function createCustomCursor() {
            if (!customCursor) {
                customCursor = document.createElement('div');
                customCursor.className = 'custom-cursor';
                customCursor.style.zIndex = '1000';
                document.body.appendChild(customCursor);
            }
        }

        function updateCursorPosition(input) {
            if (!customCursor) createCustomCursor();
            const rect = input.getBoundingClientRect();
            const inputStyle = window.getComputedStyle(input);
            const span = document.createElement('span');
            span.style.font = inputStyle.font;
            span.style.visibility = 'hidden';
            span.style.position = 'absolute';
            span.style.whiteSpace = 'pre';
            document.body.appendChild(span);
            span.textContent = input.value || '';
            const fullTextWidth = span.offsetWidth;
            const valueUpToCursor = input.value.substring(0, input.selectionStart);
            span.textContent = valueUpToCursor || '0';
            const cursorTextWidth = input.value ? (span.textContent === valueUpToCursor ? span.offsetWidth : 0) : 0;
            const spanHeight = Math.max(span.offsetHeight, 16);
            document.body.removeChild(span);
            customCursor.style.height = spanHeight + 'px';
            const verticalCenter = rect.top + window.scrollY + (rect.height - spanHeight) / 2;
            customCursor.style.top = verticalCenter + 'px';
            const inputCenterX = rect.left + window.scrollX + (rect.width / 2);
            let cursorLeft = inputCenterX - (fullTextWidth / 2) + cursorTextWidth - 2;
            customCursor.style.left = cursorLeft + 'px';
            customCursor.style.display = 'block';
        }

        let activeInput = null;
        document.addEventListener('focus', (e) => {
            if (e.target && e.target.classList && e.target.classList.contains('grid-input')) {
                activeInput = e.target;
                createCustomCursor();
                updateCursorPosition(e.target);
            }
        }, true);
        document.addEventListener('blur', (e) => {
            if (e.target && e.target.classList && e.target.classList.contains('grid-input') && customCursor) {
                activeInput = null;
                customCursor.style.display = 'none';
            }
        }, true);

        ['input', 'click', 'keydown', 'keyup'].forEach(ev => {
            document.addEventListener(ev, (e) => {
                if (e.target && e.target.classList && e.target.classList.contains('grid-input') && customCursor) {
                    requestAnimationFrame(() => updateCursorPosition(e.target));
                }
            }, true);
        });

        document.addEventListener('selectionchange', () => {
            if (activeInput && customCursor) requestAnimationFrame(() => updateCursorPosition(activeInput));
        });
        window.addEventListener('scroll', () => {
            if (activeInput && customCursor) requestAnimationFrame(() => updateCursorPosition(activeInput));
        }, true);

        function updateTotals() {
            let totalQty = 0;
            document.querySelectorAll('.number-input').forEach(input => {
                totalQty += (parseInt(input.value) || 0);
            });
            const points = (totalQty * POINT_RATE).toFixed(2);
            document.getElementById('qtyDisplay').textContent = `Qty. ${totalQty}`;
            document.getElementById('ptsDisplay').textContent = `Pts ${(totalQty * POINT_RATE * 10).toFixed(2)}`;
        }

        function clearAll() {
            document.querySelectorAll('.grid-input').forEach(input => input.value = '');
            updateTotals();
        }

        document.addEventListener('input', (e) => {
            if (e.target && e.target.classList && e.target.classList.contains('grid-input')) {
                e.target.value = e.target.value.replace(/[^0-9]/g, '');
                if (e.target.classList.contains('fill-column') || e.target.classList.contains('fill-row') || e.target.classList.contains('fill-digit-sum')) {
                    const currentVal = parseInt(e.target.value) || 0;
                    const prevVal = parseInt(e.target.getAttribute('data-prev-val')) || 0;
                    const delta = currentVal - prevVal;
                    if (e.target.classList.contains('fill-column')) {
                        const targetRow = parseInt(e.target.getAttribute('data-target-index'));
                        document.querySelectorAll(`.number-input[data-row="${targetRow}"]`).forEach(ni => {
                            const nv = (parseInt(ni.value) || 0) + delta; ni.value = nv > 0 ? nv : '';
                        });
                    } else if (e.target.classList.contains('fill-row')) {
                        const targetCol = parseInt(e.target.getAttribute('data-target-index'));
                        document.querySelectorAll(`.number-input[data-col="${targetCol}"]`).forEach(ni => {
                            const nv = (parseInt(ni.value) || 0) + delta; ni.value = nv > 0 ? nv : '';
                        });
                    } else if (e.target.classList.contains('fill-digit-sum')) {
                        const targetDigit = parseInt(e.target.getAttribute('data-target-index'));
                        document.querySelectorAll('.number-input').forEach(ni => {
                            const tens = parseInt(ni.getAttribute('data-row'));
                            const units = parseInt(ni.getAttribute('colIndex') || ni.getAttribute('data-col'));
                            if ((tens + units) % 10 === targetDigit) {
                                const nv = (parseInt(ni.value) || 0) + delta; ni.value = nv > 0 ? nv : '';
                            }
                        });
                    }
                    e.target.setAttribute('data-prev-val', currentVal);
                }
                updateTotals();
            }
        });

        document.addEventListener('focus', (e) => {
            if (e.target && e.target.classList && (e.target.classList.contains('fill-column') || e.target.classList.contains('fill-row') || e.target.classList.contains('fill-digit-sum'))) {
                e.target.setAttribute('data-prev-val', e.target.value || '0');
            }
        }, true);
        document.addEventListener('blur', (e) => {
            // No longer clearing value on blur to allow persistence
        }, true);

        document.addEventListener('keydown', (e) => {
            const inputs = Array.from(document.querySelectorAll('.grid-input'));
            const idx = inputs.indexOf(e.target);
            if (idx !== -1) {
                if (['ArrowUp', 'ArrowDown', 'ArrowLeft', 'ArrowRight'].includes(e.key)) {
                    e.preventDefault();
                    let target = null;
                    if (e.key === 'ArrowLeft') target = inputs[idx - 1];
                    else if (e.key === 'ArrowRight') target = inputs[idx + 1];
                    else {
                        const rect = e.target.getBoundingClientRect();
                        const cx = rect.left + rect.width / 2;
                        let minD = Infinity;
                        inputs.forEach(inp => {
                            if (inp === e.target) return;
                            const r = inp.getBoundingClientRect();
                            const icx = r.left + r.width / 2, icy = r.top + r.height / 2;
                            if (e.key === 'ArrowUp' && icy < rect.top) {
                                const d = rect.top - icy;
                                if (Math.abs(icx - cx) < rect.width / 2 && d < minD) { minD = d; target = inp; }
                            } else if (e.key === 'ArrowDown' && icy > rect.bottom) {
                                const d = icy - rect.bottom;
                                if (Math.abs(icx - cx) < rect.width / 2 && d < minD) { minD = d; target = inp; }
                            }
                        });
                    }
                    if (target) target.focus();
                }
            }
            if (e.key === 'F3') { e.preventDefault(); clearAll(); for (let k in tabState) tabState[k] = {}; }
            else if (e.key === 'F2') { e.preventDefault(); handleBuy(); }
            else if (e.key === 'F4') { e.preventDefault(); handleCancel(); }
            else if (e.key === 'F5') { e.preventDefault(); location.href = 'result.html'; }
            else if (e.key === 'F7') { e.preventDefault(); location.href = 'summary.html'; }
            else if (e.key.toLowerCase() === 'q' && e.target.tagName !== 'INPUT') location.href = 'index.html';
        });
    </script>
</body>

</html>