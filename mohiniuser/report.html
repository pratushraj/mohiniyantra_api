<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Coupon Details Report</title>
    <link rel="stylesheet" href="style.css">
    <script src="config.js"></script>
</head>

<body style="background-color: var(--card-bg);">
    <div class="report-header" style="display: flex;">
        <h2 style="margin: 0; flex: 1; text-align: center;">Coupon Details Report</h2>
        <button class="action-btn btn-red" style="min-width: 80px;" onclick="history.back()">Close</button>
    </div>

    <div class="report-filters">
        <label>Select Date :</label>
        <input type="date" id="targetDate" style="width: 150px; padding: 5px;">
        <label>From Time:</label>
        <select id="fromHH">
            <option value="00">00</option>
        </select>
        <select id="fromMM">
            <option value="00">00</option>
        </select>
        <label>To Time:</label>
        <select id="toHH">
            <option value="00">00</option>
        </select>
        <select id="toMM">
            <option value="00">00</option>
        </select>
        <button class="action-btn btn-blue" id="submitBtn" style="background:#4b6584; min-width: 80px;">Submit</button>
    </div>

    <div class="container fade-in" style="padding: 0;">
        <table class="data-table">
            <thead>
                <tr>
                    <th style="width: 10%;">Sr.No</th>
                    <th style="width: 30%;">GiftEventCode</th>
                    <th style="width: 30%;">Selected</th>
                    <th style="width: 30%;">Qty</th>
                </tr>
            </thead>
            <tbody id="reportTableBody">
                <!-- Data populated via JS -->
            </tbody>
        </table>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // Populate Time Dropdowns
            const hhs = document.querySelectorAll('#fromHH, #toHH');
            const mms = document.querySelectorAll('#fromMM, #toMM');

            hhs.forEach(sel => {
                sel.innerHTML = '';
                for (let i = 0; i < 24; i++) {
                    const h = String(i).padStart(2, '0');
                    sel.innerHTML += `<option value="${h}">${h}</option>`;
                }
            });
            mms.forEach(sel => {
                sel.innerHTML = '';
                for (let i = 0; i < 60; i++) {
                    const m = String(i).padStart(2, '0');
                    sel.innerHTML += `<option value="${m}">${m}</option>`;
                }
            });

            // Set today's date in YYYY-MM-DD for the date input
            const dateInput = document.getElementById('targetDate');
            const now = new Date();
            const year = now.getFullYear();
            const month = String(now.getMonth() + 1).padStart(2, '0');
            const day = String(now.getDate()).padStart(2, '0');
            dateInput.value = `${year}-${month}-${day}`;

            document.getElementById('submitBtn').addEventListener('click', fetchReport);
            fetchReport(); // Initial load
        });

        async function fetchReport() {
            const dateVal = document.getElementById('targetDate').value;
            if (!dateVal) {
                showPopup("Please select a date", "Warning");
                return;
            }

            // Convert YYYY-MM-DD input to configured format (e.g., d-m-Y) for API
            const dateParts = dateVal.split('-');
            const dObj = new Date(dateParts[0], dateParts[1] - 1, dateParts[2]);
            const apiDate = formatDate(dObj);

            // Get Time Filters
            const fromHH = document.getElementById('fromHH').value;
            const fromMM = document.getElementById('fromMM').value;
            const toHH = document.getElementById('toHH').value;
            const toMM = document.getElementById('toMM').value;

            const fromTime = `${fromHH}:${fromMM}`;
            const toTime = `${toHH}:${toMM}`;
            // If 00:00 to 00:00, show all
            const isNoTimeFilter = (fromTime === '00:00' && toTime === '00:00');

            const tbody = document.getElementById('reportTableBody');
            tbody.innerHTML = '<tr><td colspan="4">Loading...</td></tr>';

            try {
                const response = await fetch(CONFIG.TICKET_DETAILS_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        user_id: appGlobalConfig.userId,
                        date: apiDate
                    })
                });

                const json = await response.json();
                tbody.innerHTML = '';

                if (json.status && json.data) {
                    let globalIdx = 1;
                    let hasShownAny = false;

                    json.data.forEach(batch => {
                        // Filter by time range
                        const drawTime = batch.draw_time; // e.g., "12:00"
                        const isVisible = isNoTimeFilter || (drawTime >= fromTime && drawTime <= toTime);

                        if (isVisible) {
                            hasShownAny = true;

                            let batchTotalPoints = 0;
                            let batchShown = false;

                            batch.tickets.forEach(ticket => {
                                const tr = document.createElement('tr');

                                let selectedDisplay = "";
                                if (ticket.number.includes('-')) {
                                    const parts = ticket.number.split('-');
                                    selectedDisplay = `${batch.game_type_code}${parts[0]} - ${batch.game_type_code}${parts[1]}`;
                                } else {
                                    selectedDisplay = `${batch.game_type_code}${ticket.number}`;
                                }

                                batchTotalPoints += parseFloat(ticket.amount);

                                if (!batchShown) {
                                    tr.innerHTML = `
                                        <td>${globalIdx++}</td>
                                        <td>${batch.gifteventcode}</td>
                                        <td>${selectedDisplay}</td>
                                        <td>${ticket.qty}</td>
                                    `;
                                    batchShown = true;
                                } else {
                                    tr.innerHTML = `
                                        <td></td>
                                        <td></td>
                                        <td>${selectedDisplay}</td>
                                        <td>${ticket.qty}</td>
                                    `;
                                }
                                tbody.appendChild(tr);
                            });

                            // Total Points Row for this specific purchase/batch
                            const totalTr = document.createElement('tr');
                            totalTr.style.backgroundColor = "var(--header-bg)";
                            totalTr.innerHTML = `<td colspan="4" style="text-align:center; font-weight:bold;">Total Points (${batch.game_type_code}): ${batchTotalPoints.toFixed(3)}</td>`;
                            tbody.appendChild(totalTr);

                            // Gift Points Row or Cancelled Row
                            if (batch.is_cancelled) {
                                const cancelTr = document.createElement('tr');
                                cancelTr.style.backgroundColor = "var(--header-bg)";
                                let cancelDisplay = formatCancelTime(batch.cancel_time || batch.gifteventcode);
                                cancelTr.innerHTML = `<td colspan="4" style="text-align:center; color:red; font-weight:bold;">Gift Event Canceled On: ${cancelDisplay}</td>`;
                                tbody.appendChild(cancelTr);
                            } else {
                                const giftPtsTr = document.createElement('tr');
                                giftPtsTr.style.backgroundColor = "var(--header-bg)";
                                const pointsDisplay = (batch.batch_winning_amount > 0) ? parseFloat(batch.batch_winning_amount).toFixed(2) : '0';
                                giftPtsTr.innerHTML = `<td colspan="4" style="text-align:center; color:red; font-weight:bold;">Gift points are ${pointsDisplay}</td>`;
                                tbody.appendChild(giftPtsTr);
                            }

                            // Gift Code Row (Shows result if published) - Always Show
                            const giftCodeTr = document.createElement('tr');
                            giftCodeTr.style.backgroundColor = "var(--header-bg)";
                            const winDisplay = (batch.is_cancelled) ? '--' : ((batch.winning_number !== null && batch.winning_number !== undefined && batch.winning_number !== "") ? (batch.game_type_code + batch.winning_number) : '--');
                            giftCodeTr.innerHTML = `<td colspan="4" style="text-align:center; color:red; font-weight:bold;">Gift Code: ${winDisplay}</td>`;
                            tbody.appendChild(giftCodeTr);
                        }
                    });

                    if (!hasShownAny) {
                        tbody.innerHTML = `<tr><td colspan="4" style="text-align:center;">No records found for the selected time range.</td></tr>`;
                    }

                    // Calculate and show Total Summary
                    let totalQty = 0;
                    let totalPoints = 0;
                    let totalGiftPoints = 0;
                    let totalCancelPoints = 0;

                    json.data.forEach(batch => {
                        const drawTime = batch.draw_time;
                        const isVisible = isNoTimeFilter || (drawTime >= fromTime && drawTime <= toTime);
                        if (isVisible) {
                            if (batch.is_cancelled) {
                                totalCancelPoints += parseFloat(batch.cancel_amount || 0);
                            } else {
                                totalGiftPoints += parseFloat(batch.batch_winning_amount || 0);
                            }
                            batch.tickets.forEach(ticket => {
                                totalQty += parseFloat(ticket.qty || 0);
                                if (ticket.status != 0 && !batch.is_cancelled) {
                                    totalPoints += parseFloat(ticket.amount || 0);
                                }
                            });
                        }
                    });

                    const summaryDiv = document.getElementById('totalSummaryCont');
                    if (summaryDiv) {
                        summaryDiv.innerHTML = `
                            <div style="background-color: #d16666; color: black; padding: 10px 20px; display: flex; justify-content: space-between; font-weight: bold; font-size: 16px; border-top: 2px solid #000; position: fixed; bottom: 0; left: 0; right: 0; z-index: 1000;">
                                <span>Total Summary</span>
                                <span>Qty-${totalQty.toFixed(0)}</span>
                                <span>Points-${totalPoints.toFixed(2)}</span>
                                <span>Gift Points-${totalGiftPoints.toFixed(2)}</span>
                                <span>Cancel Points-${totalCancelPoints.toFixed(2)}</span>
                            </div>
                        `;
                    }

                } else {
                    tbody.innerHTML = `<tr><td colspan="4" style="text-align:center;">${json.msg || 'No data found'}</td></tr>`;
                    const summaryDiv = document.getElementById('totalSummaryCont');
                    if (summaryDiv) summaryDiv.innerHTML = '';
                }

                // Empty rows for design padding
                const spacerTr = document.createElement('tr');
                spacerTr.innerHTML = '<td colspan="4" style="height: 50px; border:none;">&nbsp;</td>';
                tbody.appendChild(spacerTr);

            } catch (error) {
                console.error("Report Fetch Error:", error);
                tbody.innerHTML = '<tr><td colspan="4" style="text-align:center;">Error loading report</td></tr>';
            }
        }

        function formatCancelTime(dateStr) {
            if (!dateStr) return '';
            try {
                const d = new Date(dateStr);
                if (isNaN(d.getTime())) return dateStr;
                const datePart = formatDate(d);
                const timePart = String(d.getHours()).padStart(2, '0') + ":" + String(d.getMinutes()).padStart(2, '0');
                return datePart + " " + timePart;
            } catch (e) { return dateStr; }
        }
    </script>
    <div id="totalSummaryCont"></div>
</body>

</html>