<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title id="page-title">Dhankeshri Play - Bulk Coupons</title>
    <link rel="stylesheet" href="style.css">
    <script src="config.js"></script>
    <script>
        window.addEventListener('DOMContentLoaded', () => {
            document.title = `${appGlobalConfig.appName} - Bulk Coupons`;
            const userSpan = document.querySelector('.top-info span:first-child');
            const balanceSpan = document.querySelector('.top-info span:last-child');
            if (userSpan) userSpan.textContent = `Welcome : ${appGlobalConfig.unique_id}`;
            if (balanceSpan) balanceSpan.textContent = `Balance Point : ${appGlobalConfig.balance}`;
        });
    </script>

    <style>
        .input-cell {
            padding: 2px !important;
            font-size: 24px !important;
            font-weight: 600 !important;
        }
    </style>
</head>

<body>
    <div class="top-bar">
        <div class="version-info">0.0.12</div>
        <div class="top-info">
            <span id="welcome-id">Welcome : 2101400016</span>
            <span id="balance-pts">Balance Point : 97885.30</span>
        </div>
        <div class="top-right-info">
            <button class="lobby-btn" onclick="location.href='index.html'">LOBBY [Q]</button>
        </div>
    </div>

    <div class="container fade-in">
        <div class="tabs-row">
            <div class="menu-tabs">
                <button class="tab tab-bulk-a active" onclick="location.href='bulk-coupons.html'">Bulk Coupons [ A
                    ]</button>
                <button class="tab tab-bulk-b" onclick="location.href='bulk-coupons-b.html'">Bulk Coupons [ B ]</button>
                <button class="tab tab-pointwise">Pointwise Coupons</button>
                <button class="tab tab-loose" onclick="location.href='loose-coupons.html'">Loose Coupons</button>
                <button class="tab tab-loose-pointwise">Loose Pointwise Coupons</button>
            </div>
            <div class="tabs-right">
                <span id="current-date">Date : 18:02:2026</span>
                <span id="event-code">Gift Event Code : 11:00</span>
                <span id="countdown-timer">Countdown : 00:04:16</span>
            </div>
        </div>

        <div style="display: none;">
            <input type="hidden" id="pointRate" value="1.10">
        </div>

        <div class="data-table-container">
            <table class="data-table">
                <thead>
                    <tr>
                        <th style="width: 200px;">Product Group</th>
                        <th style="width: 100px;">Gift Coin</th>
                        <th>00-09</th>
                        <th>10-19</th>
                        <th>20-29</th>
                        <th>30-39</th>
                        <th>40-49</th>
                        <th>50-59</th>
                        <th>60-69</th>
                        <th>70-79</th>
                        <th>80-89</th>
                        <th>90-99</th>
                        <th>All</th>
                        <th style="width: 80px;">Qty</th>
                        <th style="width: 80px;">Pts</th>
                        <th id="draw-time-header" style="width: 100px;">--:--</th>
                    </tr>
                </thead>
                <tbody id="couponBody">
                    <!-- Dynamic rows will be here -->
                </tbody>
                <tfoot>
                    <tr style="background-color: var(--header-bg); font-weight: bold;">
                        <td>All</td>
                        <td>-</td>
                        <td><input type="text" class="input-cell global-range-input" data-col="0" inputmode="numeric">
                        </td>
                        <td><input type="text" class="input-cell global-range-input" data-col="1" inputmode="numeric">
                        </td>
                        <td><input type="text" class="input-cell global-range-input" data-col="2" inputmode="numeric">
                        </td>
                        <td><input type="text" class="input-cell global-range-input" data-col="3" inputmode="numeric">
                        </td>
                        <td><input type="text" class="input-cell global-range-input" data-col="4" inputmode="numeric">
                        </td>
                        <td><input type="text" class="input-cell global-range-input" data-col="5" inputmode="numeric">
                        </td>
                        <td><input type="text" class="input-cell global-range-input" data-col="6" inputmode="numeric">
                        </td>
                        <td><input type="text" class="input-cell global-range-input" data-col="7" inputmode="numeric">
                        </td>
                        <td><input type="text" class="input-cell global-range-input" data-col="8" inputmode="numeric">
                        </td>
                        <td><input type="text" class="input-cell global-range-input" data-col="9" inputmode="numeric">
                        </td>
                        <td style="text-align: right;">TOTAL</td>
                        <td id="totalQty">0</td>
                        <td id="totalPts">0.00</td>
                        <td></td>
                    </tr>
                </tfoot>
            </table>
        </div>

        <div class="bottom-actions">
            <button class="action-btn btn-green">UPCOMMING [F1]</button>
            <button class="action-btn btn-green" id="buyBtn">SUBMIT [F2]</button>
            <button class="action-btn btn-red" onclick="clearAll()">CLEAR [F3]</button>
            <button class="action-btn btn-red" id="cancelBtn">CANCEL [F4]</button>
            <button class="action-btn btn-red" onclick="location.href='result.html'">YANTRA [F5]</button>
            <button class="action-btn btn-red" onclick="location.href='report.html'">C. DETAILS [F6]</button>
            <button class="action-btn btn-red" onclick="location.href='summary.html'">P. SUM [F7]</button>
        </div>
    </div>

    <script>
        const appConfig = {
            drawTime: '09:15',
            groups: SHARED_GROUPS
        };

        const couponBody = document.getElementById('couponBody');
        const drawTimeHeader = document.getElementById('draw-time-header');

        function initUI() {
            drawTimeHeader.textContent = appConfig.drawTime;
            couponBody.innerHTML = '';

            appConfig.groups.forEach((group, index) => {
                const tr = document.createElement('tr');
                tr.className = 'coupon-row';
                tr.setAttribute('data-game-code', group.code);
                tr.setAttribute('data-group-index', index);

                let html = `<td>${group.name} ${group.code}</td><td>-</td>`;
                for (let i = 0; i < 10; i++) {
                    html += `<td><input type="text" class="input-cell range-input" inputmode="numeric" data-num="${i}"></td>`;
                }
                html += `
                    <td><input type="text" class="input-cell all-input" style="width: 50px;" inputmode="numeric"></td>
                    <td class="qty-cell">0</td>
                    <td class="pts-cell">0.00</td>
                    <td class="result-cell" style="font-weight: bold; font-size: 14px;">-</td>
                `;
                tr.innerHTML = html;
                couponBody.appendChild(tr);
            });

            if (typeof updateDynamicUI === 'function') updateDynamicUI();
        }

        // Real-time UI Updates
        window.updateDynamicUI = function () {
            if (!window.appGameDetails) return;

            const results = window.appGameDetails.prev_game_results || [];

            // Update Draw Time Header with PREVIOUS draw time
            if (results.length > 0 && results[0].time) {
                drawTimeHeader.textContent = results[0].time;
            }

            // Update Result Cells
            const resultCells = document.querySelectorAll('.result-cell');

            resultCells.forEach((cell, index) => {
                if (results[index] && results[index].win_code) {
                    // Show ONLY the result code
                    cell.textContent = results[index].win_code;
                } else {
                    cell.textContent = '-';
                }
            });
        }

        initUI();

        // Custom 4px Thick Cursor Implementation
        let customCursor = null;

        function createCustomCursor() {
            if (!customCursor) {
                customCursor = document.createElement('div');
                customCursor.className = 'custom-cursor';
                customCursor.style.zIndex = '1000';
                document.body.appendChild(customCursor);
            }
        }

        function updateCursorPosition(input) {
            if (!customCursor) createCustomCursor();

            const rect = input.getBoundingClientRect();
            const inputStyle = window.getComputedStyle(input);

            // Measure widths
            const span = document.createElement('span');
            span.style.font = inputStyle.font;
            span.style.visibility = 'hidden';
            span.style.position = 'absolute';
            span.style.whiteSpace = 'pre';
            document.body.appendChild(span);

            // Full text width
            span.textContent = input.value || '';
            const fullTextWidth = span.offsetWidth;

            // Text width up to cursor
            const valueUpToCursor = input.value.substring(0, input.selectionStart);
            span.textContent = valueUpToCursor || 'A';
            const cursorTextWidth = input.value ? (span.textContent === valueUpToCursor ? span.offsetWidth : 0) : 0;
            const spanHeight = Math.max(span.offsetHeight, 16);

            document.body.removeChild(span);

            // Set Height
            customCursor.style.height = spanHeight + 'px';

            // Vertical Position
            const verticalCenter = rect.top + window.scrollY + (rect.height - spanHeight) / 2;
            customCursor.style.top = verticalCenter + 'px';

            // Horizontal Position (Handling Center Alignment)
            const inputCenterX = rect.left + window.scrollX + (rect.width / 2);
            let cursorLeft = inputCenterX - (fullTextWidth / 2) + cursorTextWidth;

            // Center the 4px cursor over the insertion point
            cursorLeft -= 2;

            customCursor.style.left = cursorLeft + 'px';
            customCursor.style.display = 'block';
        }

        // Track active input for cursor updates
        let activeInput = null;

        // Add focus/blur/input handlers to all input cells
        document.addEventListener('focus', (e) => {
            if (e.target && e.target.classList && e.target.classList.contains('input-cell')) {
                activeInput = e.target;
                createCustomCursor();
                updateCursorPosition(e.target);
            }
        }, true);

        document.addEventListener('blur', (e) => {
            if (e.target && e.target.classList && e.target.classList.contains('input-cell') && customCursor) {
                activeInput = null;
                customCursor.style.display = 'none';
            }
        }, true);

        // More responsive events
        document.addEventListener('input', (e) => {
            if (e.target && e.target.classList && e.target.classList.contains('input-cell') && customCursor) {
                requestAnimationFrame(() => updateCursorPosition(e.target));
            }
        }, true);

        document.addEventListener('click', (e) => {
            if (e.target && e.target.classList && e.target.classList.contains('input-cell') && customCursor) {
                requestAnimationFrame(() => updateCursorPosition(e.target));
            }
        }, true);

        document.addEventListener('keydown', (e) => {
            if (e.target && e.target.classList && e.target.classList.contains('input-cell') && customCursor) {
                requestAnimationFrame(() => updateCursorPosition(e.target));
            }
        }, true);

        document.addEventListener('keyup', (e) => {
            if (e.target && e.target.classList && e.target.classList.contains('input-cell') && customCursor) {
                requestAnimationFrame(() => updateCursorPosition(e.target));
            }
        }, true);

        // Update on selection change
        document.addEventListener('selectionchange', () => {
            if (activeInput && customCursor) {
                requestAnimationFrame(() => updateCursorPosition(activeInput));
            }
        });

        // Update on scroll
        window.addEventListener('scroll', () => {
            if (activeInput && customCursor) {
                requestAnimationFrame(() => updateCursorPosition(activeInput));
            }
        }, true);

        const pointRateInput = document.getElementById('pointRate');
        const totalQtyEl = document.getElementById('totalQty');
        const totalPtsEl = document.getElementById('totalPts');

        async function handleBuy() {
            if (!window.appGameDetails || !window.appGameDetails.timeSlotId) {
                showPopup("Game details not loaded yet. Please wait.", "Error");
                await updateLiveHeader();
                if (!window.appGameDetails.timeSlotId) return;
            }

            const tickets = [];
            const rows = document.querySelectorAll('.coupon-row');

            rows.forEach(row => {
                const code = row.getAttribute('data-game-code');
                const gameTypeId = code.includes('RM') ? 1 :
                    code.includes('RG') ? 2 :
                        code.includes('RY') ? 3 : 4;

                row.querySelectorAll('.range-input').forEach(input => {
                    const qty = parseInt(input.value) || 0;
                    if (qty > 0) {
                        tickets.push({
                            game_id: 1, // Bulk A
                            game_type_id: gameTypeId,
                            number: input.getAttribute('data-num'),
                            time_slot_id: [window.appGameDetails.timeSlotId],
                            ticket_date: window.appGameDetails.date,
                            qty: qty.toString()
                        });
                    }
                });
            });

            if (tickets.length === 0) {
                showPopup("Please enter the Bet", "Warning");
                return;
            }

            const request = {
                userId: appGlobalConfig.userId,
                tickets: tickets
            };

            const result = await postData(CONFIG.TICKET_PURCHASE_URL, request, "Ticket Purchased Successfully");
            if (result) {
                clearAll();
                if (typeof updateLiveBalance === 'function') updateLiveBalance();
            }
        }

        async function handleCancel() {
            const request = {
                userId: appGlobalConfig.userId
            };
            const result = await postData(CONFIG.CANCEL_TICKETS_URL, request, "Ticket Cancelled Successfully");
            if (result) {
                if (typeof updateLiveBalance === 'function') updateLiveBalance();
            }
        }

        document.getElementById('buyBtn').addEventListener('click', handleBuy);
        document.getElementById('cancelBtn').addEventListener('click', handleCancel);

        function calculate() {
            let grandQty = 0;
            let grandPts = 0;
            const rate = parseFloat(pointRateInput ? pointRateInput.value : 1.0) || 1.0;
            const rows = document.querySelectorAll('.coupon-row');

            rows.forEach(row => {
                const rangeInputs = row.querySelectorAll('.range-input');
                const qtyCell = row.querySelector('.qty-cell');
                const ptsCell = row.querySelector('.pts-cell');

                let rowQty = 0;
                rangeInputs.forEach(input => {
                    rowQty += parseInt(input.value) || 0;
                });

                const rowPts = rowQty * rate;
                qtyCell.textContent = rowQty;
                ptsCell.textContent = (rowPts * 10).toFixed(2);

                grandQty += rowQty;
                grandPts += (rowPts * 10);
            });

            totalQtyEl.textContent = grandQty;
            totalPtsEl.textContent = grandPts.toFixed(2);
        }

        document.addEventListener('input', (e) => {
            if (e.target && e.target.classList && (e.target.classList.contains('input-cell') || e.target.id === 'pointRate')) {
                if (e.target.classList.contains('input-cell')) {
                    e.target.value = e.target.value.replace(/[^0-9]/g, '');
                }

                // Incremental Add Logic for Bulk Inputs (on type)
                if (e.target.classList.contains('global-range-input') || e.target.classList.contains('all-input')) {
                    const currentVal = parseInt(e.target.value) || 0;
                    const prevVal = parseInt(e.target.getAttribute('data-prev-val')) || 0;
                    const delta = currentVal - prevVal;

                    if (e.target.classList.contains('global-range-input')) {
                        const colIndex = e.target.dataset.col;
                        document.querySelectorAll('.coupon-row').forEach(row => {
                            const input = row.querySelectorAll('.range-input')[colIndex];
                            const newVal = (parseInt(input.value) || 0) + delta;
                            input.value = newVal > 0 ? newVal : '';
                        });
                    } else if (e.target.classList.contains('all-input')) {
                        e.target.closest('tr').querySelectorAll('.range-input').forEach(input => {
                            const newVal = (parseInt(input.value) || 0) + delta;
                            input.value = newVal > 0 ? newVal : '';
                        });
                    }

                    e.target.setAttribute('data-prev-val', currentVal);
                }

                calculate();
            }
        });

        document.addEventListener('focus', (e) => {
            if (e.target && e.target.classList && (e.target.classList.contains('global-range-input') || e.target.classList.contains('all-input'))) {
                e.target.setAttribute('data-prev-val', e.target.value || '0');
            }
        }, true);

        document.addEventListener('blur', (e) => {
            // No longer clearing value on blur to allow persistence
        }, true);

        function clearAll() {
            document.querySelectorAll('.input-cell').forEach(input => input.value = '');
            calculate();
        }

        // Global Keyboard Shortcuts
        document.addEventListener('keydown', (e) => {
            const inputs = Array.from(document.querySelectorAll('.input-cell'));
            const currentIndex = inputs.indexOf(e.target);

            if (currentIndex !== -1) {
                if (e.key === 'ArrowUp' || e.key === 'ArrowDown' || e.key === 'ArrowLeft' || e.key === 'ArrowRight') {
                    e.preventDefault();
                    let target = null;

                    if (e.key === 'ArrowLeft') {
                        target = inputs[currentIndex - 1];
                    } else if (e.key === 'ArrowRight') {
                        target = inputs[currentIndex + 1];
                    } else {
                        // Up/Down navigation based on visual position
                        const rect = e.target.getBoundingClientRect();
                        const centerX = rect.left + rect.width / 2;
                        let minDistance = Infinity;

                        inputs.forEach(input => {
                            if (input === e.target) return;
                            const r = input.getBoundingClientRect();
                            const cx = r.left + r.width / 2;
                            const cy = r.top + r.height / 2;

                            if (e.key === 'ArrowUp' && cy < rect.top) {
                                const dx = Math.abs(cx - centerX);
                                const dy = rect.top - cy;
                                if (dx < rect.width / 2 && dy < minDistance) {
                                    minDistance = dy;
                                    target = input;
                                }
                            } else if (e.key === 'ArrowDown' && cy > rect.bottom) {
                                const dx = Math.abs(cx - centerX);
                                const dy = cy - rect.bottom;
                                if (dx < rect.width / 2 && dy < minDistance) {
                                    minDistance = dy;
                                    target = input;
                                }
                            }
                        });
                    }

                    if (target) {
                        target.focus();
                    }
                    return;
                }
            }

            if (e.key === 'F3') {
                e.preventDefault();
                clearAll();
            } else if (e.key === 'F2') {
                e.preventDefault();
                handleBuy();
            } else if (e.key === 'F4') {
                e.preventDefault();
                handleCancel();
            } else if (e.key === 'F5') {
                e.preventDefault();
                location.href = 'result.html';
            } else if (e.key === 'F7') {
                e.preventDefault();
                location.href = 'summary.html';
            } else if (e.key.toLowerCase() === 'q') {
                if (e.target.tagName !== 'INPUT') {
                    location.href = 'index.html';
                }
            }
        });

        calculate();
    </script>
</body>

</html>
</body>

</html>