<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dhankeshri Play - Login</title>
    <link rel="stylesheet" href="style.css">
    <style>
        .login-card {
            background-color: var(--card-bg);
            padding: 40px;
            border-radius: 12px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
            width: 100%;
            max-width: 400px;
            text-align: center;
        }

        .login-logo {
            font-size: 32px;
            font-weight: bold;
            color: var(--nav-dark);
            margin-bottom: 30px;
        }
    </style>
</head>

<body style="justify-content: center; align-items: center; display: flex;">
    <div class="top-bar" style="position: absolute; top: 0; width: 100%;">
        <span>0.0.12</span>
    </div>

    <div class="login-card fade-in">
        <div class="login-logo">Please Login</div>

        <div style="margin-bottom: 20px;">
            <input type="text" id="username" class="password-input input-white" style="width: 100%; margin: 10px 0;"
                placeholder="Username">
            <input type="password" id="password" class="password-input input-blue" style="width: 100%; margin: 10px 0;"
                placeholder="Password">
        </div>

        <button id="login_btn" class="action-btn btn-green"
            style="width: 100%; font-size: 18px; padding: 15px;">Login</button>

        <div style="margin-top: 20px; font-size: 13px; color: #666;">
            Please enter your credentials to continue
        </div>
    </div>

    <script src="config.js"></script>
    <script>
        const usernameInput = document.getElementById("username");
        const passwordInput = document.getElementById("password");
        const loginBtn = document.getElementById('login_btn');

        loginBtn.addEventListener('click', async (e) => {
            e.preventDefault();

            const username = usernameInput.value;
            const password = passwordInput.value;

            if (username === '' || password === '') {
                showPopup("Username or Password is missing!", "Login Error");
                return;
            }

            const loginObj = {
                email: username,
                password: password,
                cache_code: getCookie('cache') || ''
            };

            try {
                // Use default Content-Type (text/plain or none) to avoid OPTIONS preflight
                const res = await fetch(CONFIG.LOGIN_URL, {
                    method: 'POST',
                    body: JSON.stringify(loginObj)
                });

                // Read as text first to avoid crashing on error pages
                const rawResponse = await res.text();
                console.log("Raw Response:", rawResponse);

                let response;
                try {
                    response = JSON.parse(rawResponse);
                } catch (e) {
                    response = { status: false, msg: "Server sent an invalid response" };
                }

                // We ignore res.ok and check the 'status' field from your API directly
                if (response.status === true) {
                    console.log('>>> Login Success', response);
                    localStorage.setItem("loginInfo", JSON.stringify(response.data));
                    setCookie('cache', response.data.cache, 3650); // Store for 10 years (lifetime)
                    window.location = 'index.html';
                } else {
                    // This should now correctly show "Incorrect username or password"
                    showPopup(response.msg || "Login failed", "Login Error");
                }
            } catch (error) {
                // This block is hit if the browser blocks the request (CORS) or server is down
                showPopup("Unable to read the server response. This usually happens due to missing CORS headers on the API.", "Connection Error");
                console.error("Fetch Error:", error);
            }
        });
    </script>
</body>

</html>